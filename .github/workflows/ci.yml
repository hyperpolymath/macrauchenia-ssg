# SPDX-License-Identifier: AGPL-3.0-or-later
# RSR-compliant CI workflow with SHA-pinned actions

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  DENO_VERSION: v2.x

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Run linter
        run: deno lint adapters/

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Check formatting
        run: deno fmt --check adapters/

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Type check adapters
        run: deno check adapters/*.js

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint, format, typecheck]
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Run unit tests
        run: deno test --allow-read --allow-run --coverage=coverage tests/

      - name: Generate coverage report
        run: deno coverage coverage --lcov > coverage.lcov

      - name: Upload coverage
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4.6.0
        with:
          file: coverage.lcov
          fail_ci_if_error: false

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Check for eval usage
        run: |
          if grep -rE 'eval\s*\(|new\s+Function\s*\(' adapters/; then
            echo "ERROR: eval() or Function() usage detected"
            exit 1
          fi
          echo "No eval/Function usage found"

      - name: Check for hardcoded secrets
        run: |
          if grep -rEi '(password|secret|api_key)\s*[:=]\s*["\x27]' adapters/; then
            echo "ERROR: Potential hardcoded secrets detected"
            exit 1
          fi
          echo "No hardcoded secrets found"

      - name: Verify input validation
        run: |
          for f in adapters/wub.js adapters/coleslaw.js adapters/documenter.js adapters/franklin.js adapters/staticwebpages.js adapters/scalatex.js; do
            if ! grep -q 'validate\|sanitize' "$f"; then
              echo "ERROR: $f missing input validation"
              exit 1
            fi
          done
          echo "Input validation present in critical adapters"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Build check all adapters
        run: |
          echo "Checking all 28 adapters..."
          for f in adapters/*.js; do
            deno check "$f" && echo "✓ $f" || exit 1
          done
          echo "All adapters validated successfully"

  validate-exports:
    name: Validate Exports
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Verify adapter exports
        run: |
          deno eval "
            const files = [...Deno.readDirSync('adapters')].filter(f => f.name.endsWith('.js'));
            console.log('Checking ' + files.length + ' adapters...');
            for (const f of files) {
              const m = await import('./adapters/' + f.name);
              if (!m.name) throw new Error(f.name + ': missing name export');
              if (!m.tools) throw new Error(f.name + ': missing tools export');
              console.log('✓ ' + m.name + ' (' + m.tools.length + ' tools)');
            }
            console.log('All adapters have required exports');
          "
